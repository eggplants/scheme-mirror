<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<HTML>
<HEAD>
  <link rel="stylesheet" href="../style.css" type="text/css">
<TITLE>評価環境のモデル</TITLE>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-2022-JP">
</HEAD>
<BODY>

<PRE><A href="lambda.html">[Prev]</A>    <A href="scheme.html">[ Up ]</A>    <A HREF="continuation.html">[Next]</A></PRE>

<HR>

<div class="main">

<h2>評価環境のモデル</h2>

<P>
変数(関数)は，フレームの列からなる環境モデルによって管理されている．
フレームとは，変数(もちろん<A HREF="lambda.html">lambda式</A>によって記述される関数も含む)の集まりを格納する入れ物(テーブル)である．
またフレームは，それを含む上位の環境(フレームの列)を指し示すポインタを持つ．
つまり，あるフレームは別のフレームを指し，さらにそのフレームがまた別のフレームを指すというようにして，フレームの列が形成され，これが環境を定義する．
変数の値は環境を下位のフレームから上位のフレームへと順次調べることで評価される．
<div align=center>
<IMG SRC="images/frames.gif">
</div>
</P>
<P>
この図で太い矢印がフレーム同士の関係を与えている．frame1は最上位のフレームであり上位のフレームを持たない．
上述の通り，環境は(矢印でつながれた)フレームの列で構成される．
例えば環境env4は，frame4,frame2,frame1の3つのフレームの列から構成されている．
この環境env4でxの値を評価すると，まず最初のframe4の中で，xに20がバインドされている(対応づけられている)ことが分かるため，評価の結果は20となる．
frame2,frame1でもxの値が定められているが，最初に見つけられたframe4での値が有効になる．
環境env4で同様にyの値を評価すると，frame4にはyは見つからないが，上位のフレームframe2でyが15にバインドされているため，評価の結果は15となる．
またz,wの値は，frame1での値が有効であり，それぞれ-5,25となる．
一方環境env2においては，y,z,wの値は環境env4で評価したときと同じであるが，xを評価した場合には，frame2での値0が有効になる(環境env2で最初に見つかるxのバインディングが有効)．
</P>
<P>
このように，同じ変数名を使っても，それを評価する環境によって，その評価値を変えることができる．
つまり環境モデルによって，同じ変数名を大域変数と局所変数(仮引数や<A HREF="let.html">let式</A>内の変数)で使い分けられることが分かる．
またこのモデルが，<A HREF="scope.html">変数(関数)のスコープ</A>を与えることも分かる．
例えばframe1内でバインドされている変数の値は，下位のフレームに同じ変数がない限りいつでも参照できる．
つまりframe1内の変数は，スコープに制限のない大域変数である．
逆に，例えばframe6内の変数u,vは，このフレームのみでバインドされており，他からは参照できない局所変数である．

</P>
<P>
<!-- 環境env3は，frame3,frame1から構成されている．-->
ところで，環境env3でuの値を評価すると，frame3でもframe1でもuは見つからない．
このように，ある変数xをある環境で評価するとき，その環境内の全てのフレームを調べて，最上位のフレームでも変数xが見つからなければ，変数xは，(その環境では)バインドされていない変数(unbounded variable)となり，その値を得ることはできない．
このときシステムは，エラーを返す．
</P>
<P>
次の例は，上の図と同じ環境のもとで計算を行ったものである．
<PRE>
	&gt; (define x 100)
	&gt; (define y 30)
	&gt; (define z -5)
	&gt; (define w 25)
	&gt; (+ (let ((x 0) (y 15))
	       (+ (let ((x 20)) (* 2 x))
		  (let ((y 30)) y)
		  x y))
	     (let ((x 10) (z 50))
	       (* (let ((x 0) (y -10) (z 1) (w 5) (u 200) (v 300))
		    (+ x y z w u v))
		  x z))
	       x y z w)
	248235
</PRE>
</P>
<P>
Schemeに元々定義されている変数(lambda式で記述される関数を含む)を格納しているフレームをグローバルフレームという．
グローバルフレームは，最上位のフレームであり上位の環境はない．
Scheme処理系を起動した時点では，このグローバルフレームのみからなるグローバル環境が唯一存在する．
グローバル環境のもとで，新しく変数(関数)を定義すると，その定義はグローバルフレームに格納される．
</P>
<PRE>
	&gt; (define x 100)
	x
	&gt; (define f (lambda (x) (+ x 1)))
	f
</PRE>
<div align=center>
<IMG SRC="images/globalframe.gif">
</div>
<P>
図のように，関数はその本体(lambda式)を指すポインタと，本体が定義された(与えられた)ときの環境を指し示すポインタを持つ．
ここでは，関数によって指されている環境を関数の環境と呼ぶことにする．
この場合，fの本体はグローバル環境のもとで与えられているため，fの環境はグローバル環境(グローバルフレーム)である．
</P>

<P>
関数を呼び出すと，その仮引数の変数に実引数の値をバインドしたフレームが新しくつくられる．
このフレームの上位の環境は，その関数の環境である．
この新しいフレームを含めたフレームの列からなる環境を用いて，関数が評価される．

例えば，上の図の関数fについて，
<PRE>
	&gt; (f 7)
</PRE>
を実行したときは，次のような状況になる．
</P>
<div align=center>
<IMG SRC="images/evalf7.gif">
</div>
<P>
まずグローバル環境で，変数fが調べられる．
すると，変数fが関数であることが分かる．
ここで，その仮引数xに実引数7をバインドしたフレーム(frame1)が新たに生成される．
frame1の上位環境は，関数fの環境(=グローバル環境)である．
つまり(f 7)の評価を行う環境env1は，frame1とグローバルフレームで構成され，この環境で関数fの本体であるlambda式
<PRE>
	(lambda (x) (+ x 1))
</PRE>
が評価される．この環境でxの値は7(frame1での値)であるので，評価値は8になる(※システム関数+の評価を行う過程については省略した)．
<PRE>
	&gt; (f 7)
	8
</PRE>
これをみても，関数fの引数xと大域変数xとが独立に扱われていることが分かる．

また同じ関数が同時に2回以上呼び出される場合には，それぞれに対して，新しい環境が生成され，それぞれの環境のもとで評価が行われる．
<PRE>
	&gt; (* (f 7) (f 9))
	80
</PRE>
<div align=center>
<IMG SRC="images/evalf7f9.gif">
</div>
ここでは，関数の呼出し関係(ここでは，(f 7),(f 9)は関数*への引数である)を表すモデルについては，省略した．
</P>
<P>
これまでにみたように，関数呼出しにおいては，関数本体の定義と呼出しにともなう環境との組が関数の値を評価するために必要な情報を与えるが，この組を<A NAME="closure">クロージャ(closure)</A>という．
このクロージャの概念を積極的に用いれば，<A HREF="closure-object.html">オブジェクト指向的プログラミング</A>が可能になる．

</P>
</div>
<HR>
<PRE><A href="lambda.html">[Prev]</A>    <A href="scheme.html">[ Up ]</A>    <A HREF="continuation.html">[Next]</A></PRE>

<hr>
<div class="footer">

<DIV align="right">
1998-2005 CopyLeft  日置 尋久<br>
<!-- hhmts start -->
Last modified: Tue Mar 29 23:22:20 JST 2005
<!-- hhmts end -->
</DIV>
</div>
</BODY>
</HTML>
